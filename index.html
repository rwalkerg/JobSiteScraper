<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Keyword Finder</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            font-weight: bold;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 2rem;
            padding-right: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .btn:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: scale(1.05);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #0d9488; /* Dark Teal */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0f766e;
        }
        .btn-secondary {
            background-color: #475569; /* Slate 600 */
            color: white;
        }
        .btn-secondary:hover {
             background-color: #334155; /* Slate 700 */
        }
        .result-item-success {
            border-left: 4px solid #10b981; /* Green-500 */
        }
        .result-item-error {
            border-left: 4px solid #ef4444; /* Red-500 */
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">Job Keyword Finder</h1>
            <p class="text-slate-500 mt-2">Find job listings that match your skills.</p>
        </div>

        <!-- Input Section -->
        <div class="space-y-6">
            <div>
                <label for="job-sites-list" class="block text-sm font-semibold text-slate-700 mb-1">Job Site URLs</label>
                <textarea id="job-sites-list" rows="6" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Enter one job board or company careers page URL per line...&#10;https://www.linkedin.com/jobs/search/...&#10;https://www.indeed.com/q-software-developer-jobs.html&#10;https://boards.greenhouse.io/openai"></textarea>
            </div>
            <div>
                <label for="keywords-input" class="block text-sm font-semibold text-slate-700 mb-1">Keywords</label>
                <input type="text" id="keywords-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Enter keywords, separated by commas (e.g., Python, React, API)">
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col md:flex-row justify-center items-center gap-4">
            <button id="start-search-btn" class="btn btn-primary w-full md:w-auto">
                <i class="fas fa-search"></i>
                <span>Start Search</span>
            </button>
            <button id="test-scraper-btn" class="btn btn-secondary w-full md:w-auto">
                <i class="fas fa-vial"></i>
                <span>Test Scraper</span>
            </button>
        </div>

        <!-- Results Section -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Results</h2>
            <div id="results-container" class="w-full min-h-[100px] bg-slate-50 border rounded-lg p-4 space-y-3 overflow-y-auto max-h-80">
                <p class="text-slate-400">Your search results will appear here.</p>
            </div>
        </div>

    </div>

    <script type="module">
        // --- DOM Elements ---
        const jobSitesList = document.getElementById('job-sites-list');
        const keywordsInput = document.getElementById('keywords-input');
        const startSearchBtn = document.getElementById('start-search-btn');
        const testScraperBtn = document.getElementById('test-scraper-btn');
        const resultsContainer = document.getElementById('results-container');

        // --- Event Listeners ---
        startSearchBtn.addEventListener('click', runSearch);
        testScraperBtn.addEventListener('click', testScraper);

        /**
         * The main function to orchestrate the search process.
         * It first finds job links on the seed URLs, then scrapes each job link for keywords.
         */
        async function runSearch() {
            // 1. Get and validate inputs
            const seedUrls = jobSitesList.value.split('\n').map(url => url.trim()).filter(url => url.length > 0 && url.startsWith('http'));
            const keywords = keywordsInput.value.split(',').map(k => k.trim().toLowerCase()).filter(k => k);

            if (seedUrls.length === 0) {
                resultsContainer.innerHTML = '<p class="text-red-500">Please enter at least one valid URL.</p>';
                return;
            }
            if (keywords.length === 0) {
                resultsContainer.innerHTML = '<p class="text-red-500">Please enter at least one keyword.</p>';
                return;
            }

            // 2. Prepare UI for searching
            startSearchBtn.disabled = true;
            testScraperBtn.disabled = true;
            startSearchBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span class="ml-2">Searching...</span>`;
            resultsContainer.innerHTML = ''; // Clear previous results

            let totalMatchesFound = 0;

            // 3. Loop through each SEED URL to find job links
            for (const seedUrl of seedUrls) {
                updateStatus(`Scanning ${seedUrl} for job links...`);
                try {
                    const htmlContent = await scrapeUrlWithNetlifyFunction(seedUrl);
                    if (!htmlContent) {
                        throw new Error("Could not retrieve page content.");
                    }

                    const jobLinks = extractJobLinks(htmlContent, seedUrl);
                    if (jobLinks.length === 0) {
                        updateStatus(`No job links found on ${seedUrl}.`, true);
                        continue;
                    }
                    
                    updateStatus(`Found ${jobLinks.length} potential job links on ${seedUrl}. Now checking each one...`, true);

                    // 4. Loop through the discovered job links and check for keywords
                    for (let i = 0; i < jobLinks.length; i++) {
                        const jobLink = jobLinks[i];
                        updateStatus(`Checking job ${i + 1}/${jobLinks.length}: ${jobLink}`);

                        try {
                            const jobPageText = await scrapeUrlWithNetlifyFunction(jobLink);
                            if (!jobPageText) continue;

                            const textToSearch = jobPageText.toLowerCase();
                            const foundKeywords = keywords.filter(keyword => textToSearch.includes(keyword));

                            if (foundKeywords.length > 0) {
                                totalMatchesFound++;
                                const resultItem = createResultItem(
                                    true,
                                    jobLink,
                                    `Match found! Keywords: ${foundKeywords.join(', ')}`
                                );
                                resultsContainer.appendChild(resultItem);
                                resultsContainer.scrollTop = resultsContainer.scrollHeight;
                            }
                        } catch (jobError) {
                            console.error(`Failed to process job link ${jobLink}:`, jobError);
                            // Optionally display an error for individual job links
                        }
                    }

                } catch (seedError) {
                    console.error(`Failed to process seed URL ${seedUrl}:`, seedError);
                    const errorItem = createResultItem(false, seedUrl, `Could not scan this site. Error: ${seedError.message}`);
                    resultsContainer.appendChild(errorItem);
                }
            }

            // 5. Finalize UI
            if (totalMatchesFound === 0) {
                 updateStatus('Search complete. No keyword matches found in any job listings.', true);
            } else {
                 updateStatus(`Search complete. Found ${totalMatchesFound} total matching jobs.`, true);
            }

            startSearchBtn.disabled = false;
            testScraperBtn.disabled = false;
            startSearchBtn.innerHTML = `<i class="fas fa-search"></i><span>Start Search</span>`;
        }
        
        /**
         * Parses HTML content to find and return absolute URLs that appear to be job postings.
         * @param {string} htmlContent - The raw HTML of a page.
         * @param {string} baseUrl - The base URL of the page, for resolving relative links.
         * @returns {string[]} An array of unique, absolute URLs.
         */
        function extractJobLinks(htmlContent, baseUrl) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const anchors = tempDiv.querySelectorAll('a');
            const uniqueLinks = new Set();
            
            // Keywords that often appear in job posting URLs
            const jobUrlKeywords = ['job', 'career', 'opening', 'position', 'requisition', 'posting'];

            anchors.forEach(a => {
                let href = a.getAttribute('href');
                if (href) {
                    // Check if the link text or URL itself suggests it's a job
                    const linkText = a.textContent.toLowerCase();
                    const hrefLower = href.toLowerCase();
                    const isJobLink = jobUrlKeywords.some(kw => hrefLower.includes(kw) || linkText.includes(kw));

                    if (isJobLink) {
                        try {
                             // Create a full URL from a relative path (e.g., /jobs/123)
                            const absoluteUrl = new URL(href, baseUrl).href;
                            uniqueLinks.add(absoluteUrl);
                        } catch (e) {
                            console.warn(`Could not create a valid URL from href: ${href}`);
                        }
                    }
                }
            });

            return Array.from(uniqueLinks);
        }

        /**
         * A simple function to test if the scraper is working correctly.
         */
        async function testScraper() {
            resultsContainer.innerHTML = ''; // Clear results
            updateStatus('Testing scraper function by trying to fetch google.com...');
            startSearchBtn.disabled = true;
            testScraperBtn.disabled = true;
            try {
                const text = await scrapeUrlWithNetlifyFunction('https://www.google.com');
                if (text && text.length > 0) {
                    resultsContainer.innerHTML = ''; // Clear status
                    const successItem = createResultItem(true, 'https://www.google.com', 'Scraper Test Successful! Content was retrieved.');
                    resultsContainer.appendChild(successItem);
                } else {
                    throw new Error("No content was returned from the scraper function.");
                }
            } catch (error) {
                console.error("Scraper Function Test Failed:", error);
                resultsContainer.innerHTML = ''; // Clear status
                const errorItem = createResultItem(false, 'https://www.google.com', `Scraper Test Failed. Error: ${error.message}. Check the console (F12) for details.`);
                resultsContainer.appendChild(errorItem);
            } finally {
                startSearchBtn.disabled = false;
                testScraperBtn.disabled = false;
            }
        }

        /**
         * Updates a persistent status message at the bottom of the results container.
         * @param {string} message - The text to display.
         * @param {boolean} [isFinal=false] - If true, the message will have a different style.
         */
        function updateStatus(message, isFinal = false) {
            let statusEl = document.getElementById('status-message');
            if (!statusEl) {
                statusEl = document.createElement('p');
                statusEl.id = 'status-message';
                resultsContainer.appendChild(statusEl);
            }
            statusEl.textContent = message;
            statusEl.className = isFinal ? 'font-semibold text-slate-700 p-2' : 'italic text-slate-500 p-2';
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }


        /**
         * Creates an HTML element to display a search result.
         * @param {boolean} isSuccess - Whether the search for this URL was successful.
         * @param {string} url - The URL that was searched.
         * @param {string} message - The message to display (e.g., keywords found or error message).
         * @returns {HTMLElement} - The div element representing the result item.
         */
        function createResultItem(isSuccess, url, message) {
            const item = document.createElement('div');
            item.className = `p-3 rounded-md bg-white shadow-sm ${isSuccess ? 'result-item-success' : 'result-item-error'}`;
            
            let displayUrl = url;
            try {
                displayUrl = new URL(url).hostname + new URL(url).pathname;
            } catch (e) { /* use original url if invalid */ }


            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <a href="${url}" target="_blank" class="font-semibold text-teal-700 hover:underline truncate pr-4">${displayUrl}</a>
                    ${isSuccess 
                        ? '<span class="text-xs font-bold uppercase text-green-600 bg-green-100 px-2 py-1 rounded-full">Match</span>' 
                        : '<span class="text-xs font-bold uppercase text-red-600 bg-red-100 px-2 py-1 rounded-full">Failed</span>'
                    }
                </div>
                <p class="text-sm text-slate-600 mt-1">${message}</p>
            `;
            return item;
        }

        /**
         * Calls a serverless function to scrape the content of a given URL.
         * This function avoids browser CORS (Cross-Origin Resource Sharing) issues.
         * @param {string} url - The URL to scrape.
         * @returns {Promise<string|null>} - The text content of the page, or null if it fails.
         */
        async function scrapeUrlWithNetlifyFunction(url) {
            // This path assumes you have a Netlify function named 'scrape' in the default functions directory.
            const functionUrl = `/.netlify/functions/scrape`;
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Scraping function failed with status ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                return result.text;
            } catch (error) {
                console.error("Error calling scrape function:", error);
                throw error; // Re-throw the error to be handled by the runSearch function
            }
        }

    </script>
</body>
</html>
